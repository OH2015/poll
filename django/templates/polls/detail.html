{% extends 'base.html' %}
{% block title %}詳細画面{% endblock %}

<!-- 追加リソース -->
{% block extra-static %}
<!-- Vue3 -->
<script src="https://unpkg.com/vue@3"></script>
<!-- axios(API非同期通信) -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div id="app">
    [[ message ]]{{error_message}}
    
    <input hidden id="question_id" value="{{ question.id }}">
    {% csrf_token %}

    <h2>{{ question.title }}</h2>
    <p>投稿者: {{ question.author.username }}</p>
    <p>作成日: {{ question.created_at }}</p>
    <p>ジャンル:{{ question.genre.title }}</p>
    <p class="explanation">{{ question.explanation }}</p>

    <div id="content-choices" class="containner-fluid">
        <div class="row" v-for="(choice,index) in choices">
            <div class="col-sm-3 choice-text">[[ choice.choice_text ]]</div>
            <div class="col-sm-6 box">
                <div class="box-voted" v-bind:style="{ width: width(choice.votes) }"></div>
            </div>
            <div class="col-sm-3">[[ choice.votes ]]票</div>
        </div>
    </div>

    <div id="content-comments" class="containner-fluid">
        <div class="comment-form">
            <textarea cols="30" rows="4" id="comment-draft" v-model="comment_draft"></textarea>
            <br>
            <button v-on:click="postComment()">コメント</button>
        </div>

        <div class="row" v-for="( comment,index) in comments">
            <div class="comment-container">
                <div class="comment-icon"><i id="user-icon" class="fa-solid fa-circle-user fa-3x"></i></div>
                <div class="comment-contents">
                    <div class="comment-header">
                        <h3>[[ comment.user.username ]]</h3>
                        <span>1ヶ月前</span>
                    </div>
                    <div class="comment-text">
                        [[ comment.text ]]
                    </div>
                    <div class="comment-footer">
                        
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .explanation{
        padding-left: 50px;
    }
    #content-choices{
        width:100%;
        margin-top: 50px;
    }
    .choice-text{
        font-size: 20px;
    }
    #content-comments{
        border-top: solid gray 1px;
        width: 100%;
        margin-top:50px;
    }
    .comment-form{
        padding-bottom: 30px;
        border-bottom: solid gray 1px;
    }
    .box-voted{
        height: 100%;
        border-radius: 10px;
        background-color: deepskyblue;
    }
    .box-margin{
        height: 100%;
    }
    .box{
        height:30px;
    }
    .row{
        margin-top: 20px;
    }

    .comment-form{margin-top:30px;}
    #comment-draft{max-width: 500px;width:100%;}
    .comment-container{
        display: flex;
    }
    .comment-icon{margin-right: 10px;}
</style>

<script>
    Vue.createApp({
        data() {
            return {
                message: "",
                question_id: 0,
                comment_draft: "",
                choices: [],
                comments: [],
            }
        }
        ,methods: {
            // コメント投稿
            postComment(event){
                if(!this.comment_draft)return;

                axios.defaults.xsrfCookieName = 'csrftoken'
                axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"
                
                let params = new URLSearchParams();
                params.append('text', this.comment_draft);
                axios.post('/post_comment/' + this.question_id + '/', params)
                .then(res => {
                    this.comment_draft = ""
                    this.getComments()
                })
                .catch(error => {
                    this.message = "コメントの投稿に失敗しました" + error.response
                })
            },
            // コメント取得
            getComments(){
                axios.get("/api/comments/" + this.question_id)
                .then(res => {
                    this.comments = res.data
                })
                .catch(res => {
                    this.message = "コメントの取得に失敗しました" + res.data
                })
            },
            // 幅計算
            width(votes){ return (this.voteSum != 0 ? (votes * 100 / this.voteSum) : 0) + '%' }
        }
        ,mounted() {
            // question_id取得
            this.question_id = document.getElementById('question_id').value;

            // 選択肢取得
            axios.get("/api/choices/" + this.question_id,{
                    params:{sort: true}
            })
            .then(res => {
                this.choices = res.data
            })
            .catch(res => {
                this.message = "選択肢情報の取得に失敗しました" + res.data
            })
            // コメント取得
            this.getComments()
        }
        ,computed: {
            voteSum(){ return this.choices.reduce((sum,el) => sum + el.votes,0)}
        }
        // djangoのテンプレートエンジンと競合するので{}から[]に変更
        ,delimiters: ['[[', ']]']
    }).mount('#app')
</script>
{% endblock %}